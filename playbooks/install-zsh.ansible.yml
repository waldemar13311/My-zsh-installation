---
- name: Install zsh
  hosts: localhost # Или укажите хост, например, ubuntu-pg
  become: false
  gather_facts: true

  vars:
    # Пользователь, для которого устанавливается zsh
    zsh_user: waldemar13311

    # Домашняя директория пользователя в зависимости от ОС
    zsh_user_home: "{{ '/Users/' + zsh_user if ansible_os_family == 'Darwin' else '/home/' + zsh_user }}"

    # Отключить загрузку /etc/profile в .zshrc
    # Обычно /etc/profile не требуется, так как zsh имеет свою систему загрузки конфигурации
    # Включать только если нужны специфические системные настройки из /etc/profile
    zsh_load_etc_profile: false

    # Настройки локали для корректного отображения русских букв (UTF-8)
    # ru_RU.UTF-8 - для русского языка
    # en_US.UTF-8 - для английского языка
    # Добавляем в начало .zshrc для ранней инициализации
    # На macOS обычно уже установлена локаль UTF-8, но лучше явно указать
    zsh_custom_before: |
      export LANG=en_US.UTF-8
      export LC_ALL=en_US.UTF-8
      export LC_CTYPE=en_US.UTF-8

    # Использовать стабильную версию antigen вместо develop. Ветка master
    zsh_antigen_version: master

    # Тема для zsh
    # Стандартная тема Oh My Zsh - robbyrussell (тема по умолчанию)
    # Если не указать переменную, будет использоваться значение по умолчанию из роли (powerlevel10k)
    zsh_antigen_theme: "robbyrussell"

    # Отключить кастомные элементы Powerlevel9k/Powerlevel10k
    # Устанавливаем пустой список, чтобы переопределить значение по умолчанию из роли
    zsh_powerlevel_custom_elements: []

    # Настраиваем список плагинов
    zsh_antigen_bundles:
      # Подсказывает, какой пакет нужно установить, если введена команда, отсутствующая в системе (только на Linux)
      - { name: command-not-found, when: "{{ ansible_os_family != 'Darwin' }}" }

      # Копирование пути в буфер (X11, только Linux)
      - { name: copypath, when: "{{ ansible_os_family != 'Darwin' }}" }

      # Копирование файла в буфер (X11, только Linux)
      - { name: copyfile, when: "{{ ansible_os_family != 'Darwin' }}" }

      # Копирование текста, введенного в командной строке, в буфер (X11, только Linux)
      - { name: copybuffer, when: "{{ ansible_os_family != 'Darwin' }}" }

      # Универсальный распаковщик архивов
      - extract

      # Удобное переключение между фоновыми процессами (Ctrl+Z)
      - fancy-ctrl-z

      # Дополнительные команды для git
      - git-extras

      # Дополнительные команды для GNU (только Linux)
      - { name: gnu-utils, when: "{{ ansible_os_family != 'Darwin' }}" }

      # Управление сервисами systemd (только Linux)
      - { name: systemd, command: systemctl, when: "{{ ansible_os_family != 'Darwin' }}" }

      # Python (упрощает работу с Python)
      - python

      # Tmux
      - { name: tmux, command: tmux }

      # Автодополнение для команд
      - { name: zsh-users/zsh-autosuggestions, when: "{{ zsh_version is version_compare('5.0', '>=') }}" }

      # Вывод времени выполнения команд
      - popstas/zsh-command-time

      # Обновление antigen
      - { name: unixorn/autoupdate-antigen.zshplugin, when: "{{ zsh_update_interval > 0 }}" }

      # Виджеты для fzf
      - "{{ fzf_widgets }}"

      # Выделение синтаксиса (должен быть последним в списке)
      - { name: zdharma-continuum/fast-syntax-highlighting, when: "{{ zsh_version is version_compare('4.3.17', '>=') }}" }

    # Настройки горячих клавиш (hotkeys)
    zsh_hotkeys:
      # Ctrl+R для поиска по истории через fzf
      - { hotkey: '^r', action: fzf-insert-history, bundle: "{{ fzf_widgets }}" }

    # Настройки алиасов для команд
    zsh_aliases:
      - { alias: 'ls', action: 'lsd' }
      - { alias: 'll', action: 'ls -lAhFi --group-dirs last --date \"+%d.%m.%Y %H:%M\"' }
      - { alias: 'cat', action: '{{ "bat -pp" if ansible_os_family == "Darwin" else "batcat -pp" }}' }
      - { alias: 'less', action: '{{ "bat" if ansible_os_family == "Darwin" else "batcat" }}' }
      - { alias: 'copy', action: 'pbcopy', when: "{{ ansible_os_family == 'Darwin' }}" }

  pre_tasks:
    # Установка fzf через системный пакетный менеджер ДО выполнения роли
    # Это предотвращает ошибку "exec format error" - роль увидит установленный fzf
    # и не будет пытаться скачать бинарник для неправильной архитектуры
    - name: Install fzf via apt (Debian/Ubuntu)
      become: true
      ansible.builtin.package:
        name: fzf
        update_cache: true
        state: present
      when: ansible_os_family == "Debian"

    - name: Install fzf via brew (macOS)
      ansible.builtin.package:
        name: fzf
        use: homebrew
        state: present
      when: ansible_os_family == "Darwin"

  roles:
    - role: viasite-ansible.zsh

  tasks:
    # Отключить точки ожидания при автодополнении (COMPLETION_WAITING_DOTS)
    - name: Disable COMPLETION_WAITING_DOTS in .zshrc
      ansible.builtin.replace:
        path: "{{ zsh_user_home }}/.zshrc"
        regexp: '^COMPLETION_WAITING_DOTS="true"'
        replace: 'COMPLETION_WAITING_DOTS="false"'
      become: false

    # Удалить настройки POWERLEVEL9K из .zshrc (если не используется тема powerlevel9k/powerlevel10k)
    # Эти настройки не нужны для других тем и только засоряют .zshrc
    # Используем replace с regex, который удалит все строки, содержащие POWERLEVEL9K (игнорируя регистр)
    - name: Remove POWERLEVEL9K configuration lines from .zshrc
      ansible.builtin.replace:
        path: "{{ zsh_user_home }}/.zshrc"
        regexp: '(?m)^[^\n]*[Pp][Oo][Ww][Ee][Rr][Ll][Ee][Vv][Ee][Ll]9[Kk][^\n]*\n?'
        replace: ''
      become: false
      when: zsh_antigen_theme != "romkatv/powerlevel10k powerlevel10k"

    # Удалить строку DEFAULT_USER=$USER, которая осталась от POWERLEVEL9K (игнорируя регистр)
    - name: Remove DEFAULT_USER line from .zshrc
      ansible.builtin.lineinfile:
        path: "{{ zsh_user_home }}/.zshrc"
        regexp: '^DEFAULT_USER=\$USER'
        state: absent
      become: false
      when: zsh_antigen_theme != "romkatv/powerlevel10k powerlevel10k"

    # Установка полезных пакетов
    - name: Install useful packages (Debian/Ubuntu)
      become: true
      ansible.builtin.package:
        name:
          - lsd
          - bat
          - xclip
          - xsel
          - locales  # Пакет для работы с локалями (может потребоваться для UTF-8)
        update_cache: true
      when: ansible_os_family == "Debian"

    - name: Install useful packages (macOS)
      ansible.builtin.package:
        name: "{{ item }}"
        use: homebrew
        state: present
      loop:
        - lsd
        - bat
      when: ansible_os_family == "Darwin"
